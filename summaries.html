<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>סיכומים ודגמים - כימיה בן גוריון</title>
  <link rel="stylesheet" href="./style-v2.css" />

  <!-- 3Dmol -->
  <script src="./3dmol-min.js"></script>

  <style>
    .summary-section {
      background-color: #ecf0f1;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      text-align: right;
      border-right: 5px solid #e74c3c;
    }

    .summary-section h3 {
      color: #2c3e50;
      border-bottom: 1px solid #3498db;
      padding-bottom: 5px;
      margin-top: 0;
      margin-bottom: 15px;
    }

    .molecule-display {
      width: 100%;
      max-width: 600px;
      height: 350px;
      margin: 20px auto;
      border: 2px solid #3498db;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
      touch-action: none;
      background: white;
    }

    .mol-overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(255,255,255,0.90);
      border: 1px solid rgba(0,0,0,0.10);
      font-weight: 800;
      font-size: 14px;
      z-index: 5;
      user-select: none;
    }

    .sub { vertical-align: sub; font-size: smaller; }

    .mastery-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 0.95em;
    }

    .mastery-table th, .mastery-table td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
    }

    .mastery-table th {
      background-color: #34495e;
      color: white;
      font-weight: 700;
    }
  </style>
</head>

<body>

  <div class="header">
    <h1>אתר תרגול כימיה 👨‍🔬 - מכינת <b>בן גוריון</b></h1>
  </div>

  <div class="nav-bar">
    <a href="index.html" class="nav-btn">תרגול אדפטיבי (שאלות)</a>
    <a href="summaries.html" class="nav-btn active-tab">סיכומים ודגמים ויזואליים</a>
  </div>

  <div class="game-container">
    <h2>מבנה מולקולרי וקישור: דגמים אינטראקטיביים</h2>
    <p>הדגמים למטה מאפשרים לכם לסובב ולבחון את המבנה המרחבי של מולקולות מפתח. <b>לחץ וגרור על המולקולה כדי לסובב אותה.</b></p>

    <div class="summary-section">
      <h3>1. מים (H<sub class="sub">2</sub>O): מבנה זוויתי וקוטביות</h3>
      <p>למולקולת המים מבנה זוויתי (104.5°). מבנה א-סימטרי זה הופך אותה לקוטבית ויוצר קשרי מימן חזקים.</p>
      <div id="canvas_water" class="molecule-display"></div>
    </div>

    <div class="summary-section">
      <h3>2. מתאן (CH<sub class="sub">4</sub>): מבנה טטראדרי ואי-קוטביות</h3>
      <p>מבנה טטראדרי סימטרי (109.5°). מומנטי הדיפול מתבטלים והמולקולה כולה אינה קוטבית.</p>
      <div id="canvas_methane" class="molecule-display"></div>
    </div>

    <div class="summary-section">
      <h3>3. אמוניה (NH<sub class="sub">3</sub>): פירמידה משולשת</h3>
      <p>למולקולה זו גיאומטריה של פירמידה משולשת. זוג אלקטרונים לא-קושרים דוחף את קשרי המימן מטה.</p>
      <div id="canvas_ammonia" class="molecule-display"></div>
    </div>

    <div class="summary-section">
      <h3>4. פחמן דו-חמצני (CO<sub class="sub">2</sub>): מבנה קווי</h3>
      <p>למולקולה מבנה קווי (180°). למרות קשרים קוטביים, המשיכות מתבטלות בשל הסימטריה המרחבית, ולכן המולקולה אינה קוטבית.</p>
      <div id="canvas_co2" class="molecule-display"></div>
    </div>

    <div class="summary-section">
      <h3>5. מימן ציאנידי (HCN): מבנה קווי עם קשר משולש</h3>
      <p>מולקולה קווית (180°) קוטבית מאוד, המכילה קשר משולש בין הפחמן לחנקן.</p>
      <div id="canvas_hcn" class="molecule-display"></div>
    </div>

    <div class="summary-section">
      <h3>6. בורון טריפלואוריד (BF<sub class="sub">3</sub>): משולש מישורי</h3>
      <p>מולקולה סימטרית ואי-קוטבית לחלוטין. שלושה אטומים המחוברים ב-120° לאטום מרכזי (בורון).</p>
      <div id="canvas_bf3" class="molecule-display"></div>
    </div>

    <div class="summary-section">
      <h3>7. מילון מונחים מרכזי</h3>
      <p>טבלה זו מסכמת את הגיאומטריות המרחביות העיקריות והתכונות הקשורות.</p>
      <table class="mastery-table">
        <thead>
          <tr>
            <th>מבנה גיאומטרי</th>
            <th>אזורים דוחים</th>
            <th>זוגות לא-קושרים</th>
            <th>זווית אופיינית</th>
            <th>קוטביות (דוגמה)</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>קווי</td><td>2</td><td>0</td><td>180°</td><td>אינה קוטבית (CO<sub class="sub">2</sub>)</td></tr>
          <tr><td>משולש מישורי</td><td>3</td><td>0</td><td>120°</td><td>אינה קוטבית (BF<sub class="sub">3</sub>)</td></tr>
          <tr><td>זוויתית</td><td>3</td><td>1</td><td>&lt; 120°</td><td>קוטבית (SO<sub class="sub">2</sub>)</td></tr>
          <tr><td>טטראדרי</td><td>4</td><td>0</td><td>109.5°</td><td>אינה קוטבית (CH<sub class="sub">4</sub>)</td></tr>
          <tr><td>פירמידה משולשת</td><td>4</td><td>1</td><td>107°</td><td>קוטבית (NH<sub class="sub">3</sub>)</td></tr>
          <tr><td>זוויתית (מים)</td><td>4</td><td>2</td><td>104.5°</td><td>קוטבית (H<sub class="sub">2</sub>O)</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    function ensureOverlay(el, text) {
      let o = el.querySelector(".mol-overlay");
      if (!o) {
        o = document.createElement("div");
        o.className = "mol-overlay";
        el.appendChild(o);
      }
      o.textContent = text || "";
      return o;
    }

    async function loadText(path) {
      const res = await fetch(path, { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to fetch ${path} (${res.status})`);
      return await res.text();
    }

    function angleDeg(a, b, c) {
      const v1 = { x: a.x - b.x, y: a.y - b.y, z: a.z - b.z };
      const v2 = { x: c.x - b.x, y: c.y - b.y, z: c.z - b.z };
      const dot = v1.x*v2.x + v1.y*v2.y + v1.z*v2.z;
      const n1 = Math.sqrt(v1.x*v1.x + v1.y*v1.y + v1.z*v1.z);
      const n2 = Math.sqrt(v2.x*v2.x + v2.y*v2.y + v2.z*v2.z);
      const cos = Math.max(-1, Math.min(1, dot/(n1*n2)));
      return Math.acos(cos) * 180/Math.PI;
    }

    function attachControls(el, viewer, { spinAxis = "y", spinSpeed = 0.45 } = {}) {
      viewer.spin(spinAxis, spinSpeed);

      el.addEventListener("wheel", (e) => {
        e.preventDefault();
        const dy = Math.max(-120, Math.min(120, e.deltaY));
        const strength = Math.abs(dy) / 120;
        const step = 1 + (0.05 * strength);
        const zoomFactor = dy > 0 ? step : (1 / step);
        viewer.zoom(zoomFactor);
        viewer.render();
      }, { passive: false });

      const stopSpin = () => viewer.spin(false);
      el.addEventListener("mousedown", stopSpin);
      el.addEventListener("touchstart", stopSpin, { passive: true });

      const ro = new ResizeObserver(() => {
        viewer.resize();
        viewer.render();
      });
      ro.observe(el);
    }

    // ✅ Ball&Stick יציב: סטייל בסיס לכל האטומים, ואז Overrides בלי למחוק stick
    function applyBallStick(viewer, model) {
      try { model.assignBonds(); } catch (e) {}

      // בסיס לכולם
      viewer.setStyle({}, {
        stick: { radius: 0.22, multipleBonds: true },
        sphere: { scale: 0.38 }
      });

      // H
      viewer.setStyle({ elem: "H" }, {
        stick: { radius: 0.18, multipleBonds: true },
        sphere: { scale: 0.28 }
      });

      // O
      viewer.setStyle({ elem: "O" }, {
        stick: { radius: 0.22, multipleBonds: true },
        sphere: { scale: 0.46 }
      });
    }

    async function initGeneric({ elId, pdbFile, overlayText }) {
      const el = document.getElementById(elId);
      if (!el) return;

      ensureOverlay(el, "טוען…");
      const pdb = await loadText("./" + pdbFile);

      const viewer = $3Dmol.createViewer(el, {
        backgroundColor: "white",
        defaultcolors: $3Dmol.rasmolColors
      });

      const model = viewer.addModel(pdb, "pdb");
      applyBallStick(viewer, model);

      ensureOverlay(el, overlayText);
      viewer.zoomTo();
      viewer.render();
      attachControls(el, viewer, { spinAxis: "y", spinSpeed: 0.45 });
    }

    async function initWater() {
      const el = document.getElementById("canvas_water");
      if (!el) return;

      ensureOverlay(el, "טוען…");
      const pdb = await loadText("./water.pdb");

      const viewer = $3Dmol.createViewer(el, {
        backgroundColor: "white",
        defaultcolors: $3Dmol.rasmolColors
      });

      const model = viewer.addModel(pdb, "pdb");
      try { model.assignBonds(); } catch (e) {}

      // מים: סטייל לשני סוגים בלבד, אבל כולל stick (ככה רואים קשרים)
      viewer.setStyle({ elem: "H" }, { sphere: { scale: 0.28 }, stick: { radius: 0.18, multipleBonds: true } });
      viewer.setStyle({ elem: "O" }, { sphere: { scale: 0.46 }, stick: { radius: 0.22, multipleBonds: true } });

      const atoms = model.selectedAtoms({});
      const bySerial = new Map(atoms.map(a => [a.serial, a]));
      const O  = bySerial.get(1);
      const H1 = bySerial.get(2);
      const H2 = bySerial.get(3);

      let angleText = "";
      if (O && H1 && H2) {
        const ang = angleDeg(H1, O, H2);
        angleText = ` • זווית H–O–H: ${ang.toFixed(1)}°`;
      }

      ensureOverlay(el, `צורה: זוויתית (Bent)${angleText}`);
      viewer.zoomTo();
      viewer.render();
      attachControls(el, viewer, { spinAxis: "y", spinSpeed: 0.45 });
    }

    async function initCO2() {
      const el = document.getElementById("canvas_co2");
      if (!el) return;

      ensureOverlay(el, "טוען…");
      const pdb = await loadText("./co2.pdb");

      const viewer = $3Dmol.createViewer(el, {
        backgroundColor: "white",
        defaultcolors: $3Dmol.rasmolColors
      });

      const model = viewer.addModel(pdb, "pdb");
      try { model.assignBonds(); } catch (e) {}

      // ✅ קשר רגיל כ-fallback (שלא יקרה מצב שאין בכלל קווים)
      viewer.setStyle({}, {
        stick: { radius: 0.18, multipleBonds: true },
        sphere: { scale: 0.40 }
      });

      viewer.setStyle({ elem: "O" }, {
        stick: { radius: 0.18, multipleBonds: true },
        sphere: { scale: 0.48 }
      });

      viewer.setStyle({ elem: "C" }, {
        stick: { radius: 0.18, multipleBonds: true },
        sphere: { scale: 0.42 }
      });

      const atoms = model.selectedAtoms({});
      const C = atoms.find(a => a.elem === "C");
      const Os = atoms.filter(a => a.elem === "O");

      const sub = (a,b)=>({x:a.x-b.x,y:a.y-b.y,z:a.z-b.z});
      const add = (a,b)=>({x:a.x+b.x,y:a.y+b.y,z:a.z+b.z});
      const mul = (a,s)=>({x:a.x*s,y:a.y*s,z:a.z*s});
      const norm = v=>Math.sqrt(v.x*v.x+v.y*v.y+v.z*v.z);
      const unit = v=>{const n=norm(v)||1; return {x:v.x/n,y:v.y/n,z:v.z/n};};
      const cross=(a,b)=>({x:a.y*b.z-a.z*b.y,y:a.z*b.x-a.x*b.z,z:a.x*b.y-a.y*b.x});

      function drawDoubleBond(a,b){
        const u = unit(sub(b,a));
        let perp = cross(u,{x:0,y:0,z:1});
        if(norm(perp)<1e-6) perp=cross(u,{x:0,y:1,z:0});
        perp = unit(perp);

        const offset = 0.14;
        const radius = 0.11;          // ✅ עבה יותר
        const color  = 0x444444;      // ✅ צבע ברור

        viewer.addCylinder({ start: add(a,mul(perp,  offset)), end: add(b,mul(perp,  offset)), radius, color });
        viewer.addCylinder({ start: add(a,mul(perp, -offset)), end: add(b,mul(perp, -offset)), radius, color });
      }

      if (C && Os.length >= 2) {
        drawDoubleBond(C, Os[0]);
        drawDoubleBond(C, Os[1]);
        ensureOverlay(el, "צורה: קווית (Linear) • שני קשרים כפולים (O=C=O)");
      } else {
        ensureOverlay(el, "שגיאה בזיהוי האטומים לציור קשרים כפולים");
      }

      viewer.zoomTo();
      viewer.render();
      attachControls(el, viewer, { spinAxis: "y", spinSpeed: 0.45 });
    }

    window.addEventListener("DOMContentLoaded", () => {
      initWater().catch(console.error);
      initCO2().catch(console.error);

      initGeneric({ elId: "canvas_methane", pdbFile: "methane.pdb", overlayText: "צורה: טטראדרית (Tetrahedral)" }).catch(console.error);
      initGeneric({ elId: "canvas_ammonia", pdbFile: "ammonia.pdb", overlayText: "צורה: פירמידה משולשת (Trigonal pyramidal)" }).catch(console.error);
      initGeneric({ elId: "canvas_hcn", pdbFile: "hcn.pdb", overlayText: "צורה: קווית (Linear)" }).catch(console.error);
      initGeneric({ elId: "canvas_bf3", pdbFile: "bf3.pdb", overlayText: "צורה: משולש מישורי (Trigonal planar)" }).catch(console.error);
    });
  </script>
</body>
</html>
